;#Region ;**** Directives created by AutoIt3Wrapper_GUI ****
;#AutoIt3Wrapper_Compile_Both=y
;#EndRegion ;**** Directives created by AutoIt3Wrapper_GUI ****
;#include<Security.au3>
;#include 'ExtMsgBox.au3'

;_ExtMsgBoxSet(1+4+8+32, 0, -1, -1, 10, "Arial", @DesktopWidth*0.4)
;Local $YesNo = _ExtMsgBox(0,"&Adobe + VBA|Adobe|OFF", "", "Press YES to apply mitigations. Press NO to recover defaults.")
;Switch $YesNo
;       case 1
;	   SystemWideDocumentsAntiExploit1("Adobe + VBA")
;       case 2
;	   SystemWideDocumentsAntiExploit1("Adobe")	   
;       case 3
;	   SystemWideDocumentsAntiExploit1("OFF")
;	  Exit
;EndSwitch


Func SystemWideDocumentsAntiExploit1($DAEflag)

;Poprawka na zmienne wersji 4.0.0.0
If $DAEflag = 'ON' Then $DAEflag = "Adobe + VBA"

If $DAEflag = "Partial" Then
   MsgBox(262144, "", "The 'Documents Anti-Exploit' setting in the profile is equal to 'Partial'. This setting is ignored when loading the profile. Your MS Office and Adobe Acrobat Reader settings will not be changed.")
   Return
EndIf

Switch $DAEflag
 Case "Adobe + VBA"
  ;MACROS
  ;Block VBA interpreter in Microsoft Excel, Microsoft FrontPage, Microsoft Outlook, Microsoft PowerPoint, Microsoft Publisher, and Microsoft Word
   RegWrite('HKLM\Software\Policies\Microsoft\Office\16.0\Common', 'VBAOFF','REG_DWORD',Number('1'))
   RegWrite('HKLM\Software\Policies\Microsoft\Office\15.0\Common', 'VBAOFF','REG_DWORD',Number('1'))
   RegWrite('HKLM\Software\Policies\Microsoft\Office\14.0\Common', 'VBAOFF','REG_DWORD',Number('1'))
   RegWrite('HKLM\Software\Policies\Microsoft\Office\12.0\Common', 'VBAOFF','REG_DWORD',Number('1'))
   RegWrite('HKLM\Software\Policies\Microsoft\Office\11.0\Common', 'VBAOFF','REG_DWORD',Number('1'))
   RegWrite('HKLM\Software\Policies\Microsoft\Office\10.0\Common', 'VBAOFF','REG_DWORD',Number('1'))
   SystemWideAdobeAcrobatReader()
 Case "Adobe"
   SystemWideAdobeAcrobatReader()
   ; Delete VBA registry keys
   RegDelete('HKLM\Software\Policies\Microsoft\Office\16.0\Common', 'VBAOFF')
   RegDelete('HKLM\Software\Policies\Microsoft\Office\15.0\Common', 'VBAOFF')
   RegDelete('HKLM\Software\Policies\Microsoft\Office\14.0\Common', 'VBAOFF')
   RegDelete('HKLM\Software\Policies\Microsoft\Office\12.0\Common', 'VBAOFF')
   RegDelete('HKLM\Software\Policies\Microsoft\Office\11.0\Common', 'VBAOFF')
   RegDelete('HKLM\Software\Policies\Microsoft\Office\10.0\Common', 'VBAOFF')
 Case Else
  ; set to OFF = recover default MS Office and Adobe Acrobat Reader settings.
  ;MACROS
   RegDelete('HKLM\Software\Policies\Microsoft\Office\16.0\Common', 'VBAOFF')
   RegDelete('HKLM\Software\Policies\Microsoft\Office\15.0\Common', 'VBAOFF')
   RegDelete('HKLM\Software\Policies\Microsoft\Office\14.0\Common', 'VBAOFF')
   RegDelete('HKLM\Software\Policies\Microsoft\Office\12.0\Common', 'VBAOFF')
   RegDelete('HKLM\Software\Policies\Microsoft\Office\11.0\Common', 'VBAOFF')
   RegDelete('HKLM\Software\Policies\Microsoft\Office\10.0\Common', 'VBAOFF')

  ;ADOBE READEER
  ;Adobe Acrobat 10+ on Windows 64-bit - Protected Mode globally and thereby sandboxes Reader processes
  ;Adobe Reader 10+
   If @OSArch = "X64" Then
      RegDelete('HKLM\SOFTWARE\Wow6432Node\Policies\Adobe\Acrobat Reader\DC\FeatureLockDown', 'bProtectedMode')
     ;Adobe Reader 9.5 and 10.1.2+ 
      RegDelete('HKLM\SOFTWARE\Wow6432Node\Policies\Adobe\Acrobat Reader\DC\FeatureLockDown', 'bDisableJavaScript')
     ;Enhanced security when the application is running in the browser Adobe Reader 9+
      RegDelete('HKLM\SOFTWARE\Wow6432Node\Policies\Adobe\Acrobat Reader\DC\FeatureLockDown', 'bEnhancedSecurityInBrowser')
      RegDelete('HKLM\SOFTWARE\Wow6432Node\Policies\Adobe\Acrobat Reader\DC\FeatureLockDown', 'bEnhancedSecurityStandalone')
     ;11.0+ (Acrobat Reader)
      RegDelete('HKLM\SOFTWARE\Wow6432Node\Policies\Adobe\Acrobat Reader\DC\FeatureLockDown', 'iProtectedView')
     ;AppContainer Adobe Reader beta spring 2018
      RegDelete('HKLM\SOFTWARE\Wow6432Node\Policies\Adobe\Acrobat Reader\DC\FeatureLockDown', 'bEnableProtectedModeAppContainer')
   EndIf
  ;Adobe Acrobat 10+ on Windows 32-bit - Protected Mode globally and thereby sandboxes Reader processes
   RegDelete('HKLM\SOFTWARE\Policies\Adobe\Acrobat Reader\DC\FeatureLockDown', 'bProtectedMode')
   RegDelete('HKLM\SOFTWARE\Policies\Adobe\Acrobat Reader\DC\FeatureLockDown', 'bDisableJavaScript')
   RegDelete('HKLM\SOFTWARE\Policies\Adobe\Acrobat Reader\DC\FeatureLockDown', 'bEnhancedSecurityInBrowser')
   RegDelete('HKLM\SOFTWARE\Policies\Adobe\Acrobat Reader\DC\FeatureLockDown', 'bEnhancedSecurityStandalone')
   RegDelete('HKLM\SOFTWARE\Policies\Adobe\Acrobat Reader\DC\FeatureLockDown', 'iProtectedView')
   RegDelete('HKLM\SOFTWARE\Policies\Adobe\Acrobat Reader\DC\FeatureLockDown', 'bEnableProtectedModeAppContainer')
   If @OSArch = "X64" Then
      RegDelete('HKLM\SOFTWARE\Wow6432Node\Policies\Adobe\Acrobat Reader\11.0\FeatureLockDown', 'bProtectedMode')
      RegDelete('HKLM\SOFTWARE\Wow6432Node\Policies\Adobe\Acrobat Reader\11.0\FeatureLockDown', 'bDisableJavaScript')
      RegDelete('HKLM\SOFTWARE\Wow6432Node\Policies\Adobe\Acrobat Reader\11.0\FeatureLockDown', 'bEnhancedSecurityInBrowser')
      RegDelete('HKLM\SOFTWARE\Wow6432Node\Policies\Adobe\Acrobat Reader\11.0\FeatureLockDown', 'bEnhancedSecurityStandalone')
      RegDelete('HKLM\SOFTWARE\Wow6432Node\Policies\Adobe\Acrobat Reader\11.0\FeatureLockDown', 'iProtectedView')
   EndIf
   RegDelete('HKLM\SOFTWARE\Policies\Adobe\Acrobat Reader\11.0\FeatureLockDown', 'bProtectedMode')
   RegDelete('HKLM\SOFTWARE\Policies\Adobe\Acrobat Reader\11.0\FeatureLockDown', 'bDisableJavaScript')
   RegDelete('HKLM\SOFTWARE\Policies\Adobe\Acrobat Reader\11.0\FeatureLockDown', 'bEnhancedSecurityInBrowser')
   RegDelete('HKLM\SOFTWARE\Policies\Adobe\Acrobat Reader\11.0\FeatureLockDown', 'bEnhancedSecurityStandalone')
   RegDelete('HKLM\SOFTWARE\Policies\Adobe\Acrobat Reader\11.0\FeatureLockDown', 'iProtectedView')
EndSwitch

EndFunc

Func SystemWideAdobeAcrobatReader()
  ;ADOBE READEER
  ;Adobe Acrobat 10+ on Windows 64-bit Enables Protected Mode globally and thereby sandboxes Reader processes
  ;Adobe Reader 10+
   If @OSArch = "X64" Then
      RegWrite('HKLM\SOFTWARE\Wow6432Node\Policies\Adobe\Acrobat Reader\DC\FeatureLockDown', 'bProtectedMode','REG_DWORD',Number('1'))
     ;Adobe Reader 9.5 and 10.1.2+ 
      RegWrite('HKLM\SOFTWARE\Wow6432Node\Policies\Adobe\Acrobat Reader\DC\FeatureLockDown', 'bDisableJavaScript','REG_DWORD',Number('1'))
     ;Enhanced security when the application is running in the browser Adobe Reader 9+
      RegWrite('HKLM\SOFTWARE\Wow6432Node\Policies\Adobe\Acrobat Reader\DC\FeatureLockDown', 'bEnhancedSecurityInBrowser','REG_DWORD',Number('1'))
      RegWrite('HKLM\SOFTWARE\Wow6432Node\Policies\Adobe\Acrobat Reader\DC\FeatureLockDown', 'bEnhancedSecurityStandalone','REG_DWORD',Number('1'))
     ;11.0+ (Acrobat Reader)
      RegWrite('HKLM\SOFTWARE\Wow6432Node\Policies\Adobe\Acrobat Reader\DC\FeatureLockDown', 'iProtectedView','REG_DWORD',Number('2'))
     ;Enable AppContainer Adobe Reader beta spring 2018
      RegWrite('HKLM\SOFTWARE\Wow6432Node\Policies\Adobe\Acrobat Reader\DC\FeatureLockDown', 'bEnableProtectedModeAppContainer','REG_DWORD',Number('1'))
   EndIf
  ;Adobe Acrobat 10+ on Windows 32-bit Enables Protected Mode globally and thereby sandboxes Reader processes
   RegWrite('HKLM\SOFTWARE\Policies\Adobe\Acrobat Reader\DC\FeatureLockDown', 'bProtectedMode','REG_DWORD',Number('1'))
   RegWrite('HKLM\SOFTWARE\Policies\Adobe\Acrobat Reader\DC\FeatureLockDown', 'bDisableJavaScript','REG_DWORD',Number('1'))
   RegWrite('HKLM\SOFTWARE\Policies\Adobe\Acrobat Reader\DC\FeatureLockDown', 'bEnhancedSecurityInBrowser','REG_DWORD',Number('1'))
   RegWrite('HKLM\SOFTWARE\Policies\Adobe\Acrobat Reader\DC\FeatureLockDown', 'bEnhancedSecurityStandalone','REG_DWORD',Number('1'))
   RegWrite('HKLM\SOFTWARE\Policies\Adobe\Acrobat Reader\DC\FeatureLockDown', 'iProtectedView','REG_DWORD',Number('2'))
   RegWrite('HKLM\SOFTWARE\Policies\Adobe\Acrobat Reader\DC\FeatureLockDown', 'bEnableProtectedModeAppContainer','REG_DWORD',Number('1'))
   If @OSArch = "X64" Then
      RegWrite('HKLM\SOFTWARE\Wow6432Node\Policies\Adobe\Acrobat Reader\11.0\FeatureLockDown', 'bProtectedMode','REG_DWORD',Number('1'))
      RegWrite('HKLM\SOFTWARE\Wow6432Node\Policies\Adobe\Acrobat Reader\11.0\FeatureLockDown', 'bDisableJavaScript','REG_DWORD',Number('1'))
      RegWrite('HKLM\SOFTWARE\Wow6432Node\Policies\Adobe\Acrobat Reader\11.0\FeatureLockDown', 'bEnhancedSecurityInBrowser','REG_DWORD',Number('1'))
      RegWrite('HKLM\SOFTWARE\Wow6432Node\Policies\Adobe\Acrobat Reader\11.0\FeatureLockDown', 'bEnhancedSecurityStandalone','REG_DWORD',Number('1'))
      RegWrite('HKLM\SOFTWARE\Wow6432Node\Policies\Adobe\Acrobat Reader\11.0\FeatureLockDown', 'iProtectedView','REG_DWORD',Number('2'))
   EndIf
   RegWrite('HKLM\SOFTWARE\Policies\Adobe\Acrobat Reader\11.0\FeatureLockDown', 'bProtectedMode','REG_DWORD',Number('1'))
   RegWrite('HKLM\SOFTWARE\Policies\Adobe\Acrobat Reader\11.0\FeatureLockDown', 'bDisableJavaScript','REG_DWORD',Number('1'))
   RegWrite('HKLM\SOFTWARE\Policies\Adobe\Acrobat Reader\11.0\FeatureLockDown', 'bEnhancedSecurityInBrowser','REG_DWORD',Number('1'))
   RegWrite('HKLM\SOFTWARE\Policies\Adobe\Acrobat Reader\11.0\FeatureLockDown', 'bEnhancedSecurityStandalone','REG_DWORD',Number('1'))
   RegWrite('HKLM\SOFTWARE\Policies\Adobe\Acrobat Reader\11.0\FeatureLockDown', 'iProtectedView','REG_DWORD',Number('2'))
EndFunc

